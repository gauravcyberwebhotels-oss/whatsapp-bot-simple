<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsApp Bulk Messenger Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
       
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dark: #1f2937;
            --light: #f8fafc;
        }
       
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }
       
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
       
        .header {
            background: linear-gradient(135deg, var(--dark) 0%, #374151 100%);
            color: white;
            padding: 40px 30px;
            text-align: center;
        }
       
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
       
        .stats-bar {
            background: var(--light);
            padding: 15px 30px;
            display: flex;
            justify-content: space-around;
            border-bottom: 1px solid #e5e7eb;
        }
       
        .stat-item {
            text-align: center;
        }
       
        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
        }
       
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            padding: 40px 30px;
        }
       
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
       
        .panel {
            background: var(--light);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
       
        .panel h2 {
            color: var(--dark);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
        }
       
        .form-group {
            margin-bottom: 25px;
        }
       
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
       
        input, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
       
        input:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
       
        .btn-group {
            display: flex;
            gap: 15px;
            margin: 25px 0;
        }
       
        .btn {
            flex: 1;
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
       
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
       
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: white;
        }
       
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
       
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
        }
       
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
       
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
       
        .status-container {
            margin-top: 25px;
        }
       
        .status {
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            display: none;
        }
       
        .status-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
       
        .status-error {
            background: #fee2e2;
            color: #7f1d1d;
            border: 1px solid #fca5a5;
        }
       
        .status-loading {
            background: #dbeafe;
            color: #1e3a8a;
            border: 1px solid #93c5fd;
        }
       
        .status-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
       
        .user-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }
       
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
       
        .info-item {
            display: flex;
            flex-direction: column;
        }
       
        .info-label {
            font-size: 0.9rem;
            color: #6b7280;
            margin-bottom: 5px;
        }
       
        .info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }
       
        .auth-form {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
       
        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }
       
        .feature {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
       
        .feature i {
            font-size: 2rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        .feature-badge {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-top: 10px;
            display: inline-block;
        }
       
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
       
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .uptime-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: var(--success);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 10px;
        }
        .server-status {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        .status-online {
            background: var(--success);
        }
        .status-offline {
            background: var(--danger);
        }
        .activity-section {
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .activity-item {
            padding: 10px;
            border-left: 3px solid var(--primary);
            background: white;
            margin-bottom: 8px;
            border-radius: 0 5px 5px 0;
        }
        .activity-time {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .activity-type {
            font-weight: 600;
            color: var(--dark);
        }
        .bot-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
            margin: 20px 0;
        }
        .control-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            transition: width 0.3s ease;
        }
        .activity-log {
            background: #1f2937;
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .log-entry {
            margin-bottom: 5px;
            padding: 2px 0;
        }
        .log-time {
            color: #9ca3af;
        }
        .log-success {
            color: #10b981;
        }
        .log-error {
            color: #ef4444;
        }
        .log-warning {
            color: #f59e0b;
        }
        .log-info {
            color: #3b82f6;
        }
        .qr-container {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            margin: 20px 0;
        }
        .qr-placeholder {
            width: 200px;
            height: 200px;
            background: #f3f4f6;
            border: 2px dashed #d1d5db;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
            color: #6b7280;
        }
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-card .number {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }
        .stat-card .label {
            font-size: 0.8rem;
            color: #6b7280;
        }
        .tab-container {
            margin: 20px 0;
        }
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 20px;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fab fa-whatsapp"></i> WhatsApp Bulk Messenger Pro</h1>
            <p>Enterprise-grade automation with 24/7 uptime guarantee</p>
            <div class="uptime-indicator">
                <i class="fas fa-circle"></i> 24/7 ONLINE
            </div>
        </div>
       
        <div class="stats-bar">
            <div class="stat-item">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Total Users</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="activeBots">0</div>
                <div class="stat-label">Active Bots</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="serverCount">5</div>
                <div class="stat-label">Bot Servers</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">500+</div>
                <div class="stat-label">Capacity</div>
            </div>
        </div>
       
        <div class="main-content">
            <!-- LEFT PANEL - AUTHENTICATION & CONTROLS -->
            <div class="panel">
                <!-- AUTH SECTION -->
                <div id="authSection">
                    <div class="auth-form" id="loginForm">
                        <h2><i class="fas fa-sign-in-alt"></i> Login to Your Account</h2>
                        <div class="form-group">
                            <label for="loginEmail">Email Address</label>
                            <input type="email" id="loginEmail" placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="loginPassword">Password</label>
                            <input type="password" id="loginPassword" placeholder="Your password">
                        </div>
                        <button class="btn btn-primary" onclick="loginWithValidation()">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </button>
                        <p style="text-align: center; margin-top: 15px;">
                            Don't have an account? <a href="javascript:void(0)" onclick="showRegister()" style="color: var(--primary);">Register here</a>
                        </p>
                    </div>
                   
                    <div class="auth-form" id="registerForm" style="display:none">
                        <h2><i class="fas fa-user-plus"></i> Create Account</h2>
                        <div class="form-group">
                            <label for="registerEmail">Email Address</label>
                            <input type="email" id="registerEmail" placeholder="your@email.com">
                        </div>
                        <div class="form-group">
                            <label for="registerPassword">Password</label>
                            <input type="password" id="registerPassword" placeholder="Create a password">
                        </div>
                        <button class="btn btn-primary" onclick="registerWithValidation()">
                            <i class="fas fa-user-plus"></i> Register
                        </button>
                        <p style="text-align: center; margin-top: 15px;">
                            Already have an account? <a href="javascript:void(0)" onclick="showLogin()" style="color: var(--primary);">Login here</a>
                        </p>
                    </div>
                </div>
                <!-- DASHBOARD SECTION (SHOWN AFTER LOGIN) -->
                <div id="dashboardSection" style="display:none">
                    <h2><i class="fas fa-rocket"></i> Bot Control Center</h2>
                   
                    <div class="user-info">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Your Email</span>
                                <span class="info-value" id="userEmail">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Credits Remaining</span>
                                <span class="info-value" id="userCredits">0</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Account Status</span>
                                <span class="info-value" id="userStatus">-</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Secret Key</span>
                                <span class="info-value">
                                    <span id="userSecretKey">-</span>
                                    <button class="btn btn-secondary" onclick="copySecretKey()" style="padding: 5px 10px; margin-left: 10px;">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="tab-container">
                        <div class="tabs">
                            <div class="tab active" onclick="switchTab('spreadsheet')">Spreadsheet</div>
                            <div class="tab" onclick="switchTab('botControl')">Bot Control</div>
                            <div class="tab" onclick="switchTab('activity')">Activity</div>
                        </div>
                        <!-- SPREADSHEET TAB -->
                        <div id="spreadsheetTab" class="tab-content active">
                            <div class="form-group">
                                <label for="spreadsheetUrl"><i class="fas fa-table"></i> Your Google Sheet URL</label>
                                <input type="url" id="spreadsheetUrl"
                                       placeholder="https://docs.google.com/spreadsheets/d/your-sheet-id/edit"
                                       required>
                                <small style="color: #6b7280; font-size: 0.9rem;">
                                    üìã Create a Google Sheet with Column A for phone numbers and Column B for messages. Share with "Anyone can edit" and paste the URL here.
                                </small>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-primary" onclick="saveSpreadsheet()" id="saveSheetBtn">
                                    <i class="fas fa-save"></i> SAVE SPREADSHEET
                                </button>
                            </div>
                        </div>
                        <!-- BOT CONTROL TAB -->
                        <div id="botControlTab" class="tab-content">
                            <div class="bot-controls">
                                <h3><i class="fas fa-robot"></i> Bot Management</h3>
                                <div class="control-buttons">
                                    <button class="btn btn-success" onclick="startBot()" id="startBtn">
                                        <i class="fas fa-play"></i> START BOT
                                    </button>
                                    <button class="btn btn-danger" onclick="stopBot()" id="stopBtn" disabled>
                                        <i class="fas fa-stop"></i> STOP BOT
                                    </button>
                                </div>
                               
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                               
                                <div class="activity-log" id="botLog">
                                    <div class="log-entry">
                                        <span class="log-time">[00:00:00]</span>
                                        <span class="log-info">Bot console ready...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- ACTIVITY TAB -->
                        <div id="activityTab" class="tab-content">
                            <div class="stats-cards">
                                <div class="stat-card">
                                    <div class="number" id="totalActivities">0</div>
                                    <div class="label">Total Activities</div>
                                </div>
                                <div class="stat-card">
                                    <div class="number" id="filesUploaded">0</div>
                                    <div class="label">Files Uploaded</div>
                                </div>
                                <div class="stat-card">
                                    <div class="number" id="botSessionsCount">0</div>
                                    <div class="label">Bot Sessions</div>
                                </div>
                                <div class="stat-card">
                                    <div class="number" id="firstSeen">-</div>
                                    <div class="label">First Seen</div>
                                </div>
                            </div>
                            <div class="activity-section" id="activityHistory">
                                <!-- Activity items will be populated here -->
                            </div>
                        </div>
                    </div>
                    <div class="status-container">
                        <div id="status" class="status"></div>
                    </div>
                </div>
            </div>
            <!-- RIGHT PANEL - ACTIVITY & FEATURES -->
            <div class="panel">
                <h2><i class="fas fa-chart-bar"></i> Activity Monitor</h2>
               
                <div class="user-info">
                    <div class="info-grid">
                        <div class="info-item">
                            <span class="info-label">Bot Status</span>
                            <span class="info-value" id="botStatusDisplay">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Assigned Server</span>
                            <span class="info-value" id="assignedServer">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Started At</span>
                            <span class="info-value" id="startedAt">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Last Updated</span>
                            <span class="info-value" id="lastUpdated">-</span>
                        </div>
                    </div>
                </div>
                <h3 style="margin: 20px 0 10px 0;"><i class="fas fa-server"></i> Server Status</h3>
                <div id="serverStatus" style="margin-bottom: 20px;">
                    <!-- Server status will be populated by JavaScript -->
                </div>
                <!-- QR Code Section -->
                <div class="qr-container" id="qrSection" style="display:none">
                    <h3><i class="fas fa-qrcode"></i> WhatsApp QR Code</h3>
                    <p>Scan this QR code with your phone to connect WhatsApp</p>
                    <div class="qr-placeholder">
                        <i class="fas fa-qrcode" style="font-size: 3rem;"></i>
                    </div>
                    <p style="margin-top: 10px; font-size: 0.9rem; color: #6b7280;">
                        The bot will automatically start after successful QR scan
                    </p>
                </div>
                <div class="features">
                    <div class="feature">
                        <i class="fas fa-shield-alt"></i>
                        <h3>100% Secure</h3>
                        <p>Individual sessions for each user</p>
                    </div>
                    <div class="feature">
                        <i class="fas fa-bolt"></i>
                        <h3>High Speed</h3>
                        <p>5 optimized bot servers</p>
                        <div class="feature-badge">24/7 UPTIME</div>
                    </div>
                    <div class="feature">
                        <i class="fas fa-infinity"></i>
                        <h3>Massive Scale</h3>
                        <p>500+ users simultaneously</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- VERIFICATION MODAL -->
    <div class="modal" id="verificationModal">
        <div class="modal-content">
            <h2><i class="fas fa-envelope"></i> Verify Your Email</h2>
            <div class="form-group">
                <label for="verifyCode">Verification Code</label>
                <input type="text" id="verifyCode" placeholder="Enter 6-digit code">
                <small style="color: #6b7280;">Check your email for the verification code</small>
            </div>
            <div class="btn-group">
                <button class="btn btn-primary" onclick="verifyEmail()">
                    <i class="fas fa-check"></i> Verify
                </button>
                <button class="btn btn-secondary" onclick="hideVerificationModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    <!-- BOT STATUS MODAL -->
    <div class="modal" id="botStatusModal">
        <div class="modal-content">
            <h2><i class="fas fa-robot"></i> Bot Status</h2>
            <div id="botStatusContent">
                <!-- Bot status content will be populated here -->
            </div>
            <div class="btn-group" style="margin-top: 20px;">
                <button class="btn btn-secondary" onclick="hideBotStatusModal()">
                    <i class="fas fa-times"></i> Close
                </button>
            </div>
        </div>
    </div>
    <script>
    // API Configuration - UPDATE THIS TO YOUR BACKEND URL
    const API_BASE = 'https://my-whatsapp-brain.onrender.com';

    // User data
    let userSecretKey = '';
    let userEmail = '';
    let botStatusInterval = null;
    let activityUpdateInterval = null;

    // Authentication functions
    async function registerWithValidation() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
       
        if (!email || !password) {
            showStatus('Please enter both email and password', 'error');
            return;
        }
        if (!isValidEmail(email)) {
            showStatus('Please enter a valid email address', 'error');
            return;
        }
        if (password.length < 6) {
            showStatus('Password must be at least 6 characters long', 'error');
            return;
        }
        
        document.getElementById('status').style.display = 'none';
        await register();
    }

    async function register() {
        const email = document.getElementById('registerEmail').value;
        const password = document.getElementById('registerPassword').value;
       
        showStatus('Creating your account...', 'loading');
        
        const registerBtn = document.querySelector('#registerForm button[type="submit"]');
        if (registerBtn) {
            registerBtn.disabled = true;
            registerBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> REGISTERING...';
        }
        
        try {
            const response = await fetch(API_BASE + '/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password})
            });
           
            const result = await response.json();
           
            if (response.ok) {
                userSecretKey = result.secret_key;
                userEmail = email;
                showVerificationModal();
                showStatus('Registration successful! Check your email for verification code.', 'success');
            } else {
                throw new Error(result.error || result.message || `Registration failed with status ${response.status}`);
            }
           
        } catch (error) {
            handleFetchError(error, 'registration');
        } finally {
            if (registerBtn) {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> REGISTER';
            }
        }
    }

    async function loginWithValidation() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
       
        if (!email || !password) {
            showStatus('Please enter both email and password', 'error');
            return;
        }
        if (!isValidEmail(email)) {
            showStatus('Please enter a valid email address', 'error');
            return;
        }
        
        document.getElementById('status').style.display = 'none';
        await login();
    }

    async function login() {
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
       
        showStatus('Logging in...', 'loading');
        
        const loginBtn = document.querySelector('#loginForm button[type="submit"]');
        if (loginBtn) {
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> LOGGING IN...';
        }
        
        try {
            const response = await fetch(API_BASE + '/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email, password})
            });
           
            const result = await response.json();
           
            if (response.ok) {
                userSecretKey = result.secret_key;
                userEmail = email;
                showDashboard();
                showStatus('Login successful!', 'success');
                loadUserProfile();
                loadUserActivity();
                startStatusMonitoring();
                saveUserSession();
            } else {
                throw new Error(result.error || result.message || `Login failed with status ${response.status}`);
            }
           
        } catch (error) {
            handleFetchError(error, 'login');
        } finally {
            if (loginBtn) {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> LOGIN';
            }
        }
    }

    async function verifyEmail() {
        const code = document.getElementById('verifyCode').value;
       
        if (!code) {
            showStatus('Please enter verification code', 'error');
            return;
        }
        
        showStatus('Verifying your email...', 'loading');
        
        const verifyBtn = document.querySelector('#verificationModal button');
        if (verifyBtn) {
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> VERIFYING...';
        }
        
        try {
            const response = await fetch(API_BASE + '/verify', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({email: userEmail, code})
            });
           
            const result = await response.json();
           
            if (response.ok) {
                hideVerificationModal();
                showDashboard();
                showStatus('Email verified successfully!', 'success');
                loadUserProfile();
            } else {
                throw new Error(result.error || result.message || 'Verification failed');
            }
           
        } catch (error) {
            handleFetchError(error, 'verification');
        } finally {
            if (verifyBtn) {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check"></i> VERIFY';
            }
        }
    }

    async function saveSpreadsheet() {
        const spreadsheetUrl = document.getElementById('spreadsheetUrl').value;
       
        if (!spreadsheetUrl) {
            showStatus('Please enter your Google Sheet URL', 'error');
            return;
        }
        if (!userSecretKey) {
            showStatus('Please login first', 'error');
            return;
        }
        
        const saveSheetBtn = document.getElementById('saveSheetBtn');
        saveSheetBtn.disabled = true;
        saveSheetBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> SAVING...';
       
        try {
            const response = await fetch(API_BASE + '/save_spreadsheet', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    secret_key: userSecretKey,
                    spreadsheet_url: spreadsheetUrl
                })
            });
           
            const result = await response.json();
           
            if (response.ok) {
                showStatus('Spreadsheet URL saved successfully!', 'success');
                addBotLog('Spreadsheet saved successfully', 'success');
            } else {
                throw new Error(result.error || result.message || 'Failed to save spreadsheet');
            }
           
        } catch (error) {
            handleFetchError(error, 'save spreadsheet');
        } finally {
            saveSheetBtn.disabled = false;
            saveSheetBtn.innerHTML = '<i class="fas fa-save"></i> SAVE SPREADSHEET';
        }
    }

    async function startBot() {
        if (!userSecretKey) {
            showStatus('Please login first', 'error');
            return;
        }
        
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
       
        startBtn.disabled = true;
        startBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> STARTING...';
        showStatus('Starting your WhatsApp bot...', 'loading');
       
        document.getElementById('qrSection').style.display = 'block';
       
        addBotLog('üöÄ Starting WhatsApp Bot...', 'info');
        addBotLog('üì± Please scan the QR code when it appears', 'warning');
        addBotLog('‚è≥ Bot will start automatically after QR scan', 'info');
        
        try {
            const response = await fetch(API_BASE + '/start', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    secret_key: userSecretKey
                })
            });
           
            const result = await response.json();
           
            if (response.ok) {
                showStatus('Bot started successfully! Running 24/7...', 'success');
                stopBtn.disabled = false;
               
                addBotLog('‚úÖ Bot started successfully!', 'success');
                addBotLog('üîÑ Bot is now running on: ' + result.assigned_server, 'info');
                addBotLog('üìä Processing your spreadsheet data...', 'info');
               
                simulateBotProgress();
                updateBotStatus();
            } else {
                throw new Error(result.error || result.message || 'Failed to start bot');
            }
           
        } catch (error) {
            handleFetchError(error, 'start bot');
        } finally {
            startBtn.disabled = false;
            startBtn.innerHTML = '<i class="fas fa-play"></i> START BOT';
        }
    }

    async function stopBot() {
        if (!userSecretKey) {
            showStatus('Please login first', 'error');
            return;
        }
        
        const stopBtn = document.getElementById('stopBtn');
        stopBtn.disabled = true;
        stopBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> STOPPING...';
        showStatus('Stopping your bot...', 'loading');
       
        addBotLog('üõë Stopping bot...', 'warning');
        
        try {
            const response = await fetch(API_BASE + '/stop', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    secret_key: userSecretKey
                })
            });
           
            const result = await response.json();
           
            if (response.ok) {
                showStatus('Bot stopped successfully!', 'success');
                addBotLog('‚úÖ Bot stopped successfully!', 'success');
               
                document.getElementById('qrSection').style.display = 'none';
                document.getElementById('progressFill').style.width = '0%';
               
                updateBotStatus();
            } else {
                throw new Error(result.error || result.message || 'Failed to stop bot');
            }
           
        } catch (error) {
            handleFetchError(error, 'stop bot');
        } finally {
            stopBtn.disabled = false;
            stopBtn.innerHTML = '<i class="fas fa-stop"></i> STOP BOT';
        }
    }

    function simulateBotProgress() {
        let progress = 0;
        const progressBar = document.getElementById('progressFill');
        const interval = setInterval(() => {
            progress += Math.random() * 5;
            if (progress >= 100) {
                progress = 100;
                clearInterval(interval);
                addBotLog('üéâ Bot completed processing all contacts!', 'success');
            }
            progressBar.style.width = progress + '%';
        }, 1000);
    }

    function addBotLog(message, type = 'info') {
        const logContainer = document.getElementById('botLog');
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        logEntry.innerHTML = `
            <span class="log-time">[${timestamp}]</span>
            <span class="log-${type}">${message}</span>
        `;
        logContainer.appendChild(logEntry);
        logContainer.scrollTop = logContainer.scrollHeight;
    }

    async function loadUserProfile() {
        if (!userSecretKey) return;
       
        try {
            const response = await fetch(API_BASE + '/user/profile', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({secret_key: userSecretKey})
            });
           
            const result = await response.json();
           
            if (response.ok) {
                document.getElementById('userEmail').textContent = result.email;
                document.getElementById('userCredits').textContent = result.credits;
                document.getElementById('userStatus').textContent = result.verified ? 'Verified ‚úÖ' : 'Not Verified ‚ùå';
                document.getElementById('userSecretKey').textContent = userSecretKey;
               
                if (result.spreadsheet_url) {
                    document.getElementById('spreadsheetUrl').value = result.spreadsheet_url;
                }
            }
        } catch (error) {
            handleFetchError(error, 'load profile');
        }
    }

    async function loadUserActivity() {
        if (!userSecretKey) return;
       
        try {
            const response = await fetch(API_BASE + '/user/activity', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({secret_key: userSecretKey})
            });
           
            const result = await response.json();
           
            if (response.ok && result.user_data) {
                const userData = result.user_data;
               
                document.getElementById('totalActivities').textContent = userData.activity_history ? userData.activity_history.length : 0;
                document.getElementById('filesUploaded').textContent = userData.files_uploaded ? userData.files_uploaded.length : 0;
                document.getElementById('botSessionsCount').textContent = userData.bot_sessions ? userData.bot_sessions.length : 0;
                document.getElementById('firstSeen').textContent = userData.first_seen ? new Date(userData.first_seen).toLocaleDateString() : '-';
               
                updateActivityHistory(userData.activity_history || []);
            }
        } catch (error) {
            handleFetchError(error, 'load activity');
        }
    }

    function updateActivityHistory(activities) {
        const activityContainer = document.getElementById('activityHistory');
        activityContainer.innerHTML = '';
       
        const recentActivities = activities.slice(-10).reverse();
       
        recentActivities.forEach(activity => {
            const activityItem = document.createElement('div');
            activityItem.className = 'activity-item';
           
            const time = new Date(activity.timestamp).toLocaleString();
            const type = activity.type.replace(/_/g, ' ').toUpperCase();
           
            activityItem.innerHTML = `
                <div class="activity-type">${type}</div>
                <div class="activity-time">${time}</div>
            `;
           
            activityContainer.appendChild(activityItem);
        });
    }

    async function updateBotStatus() {
        if (!userSecretKey) return;
       
        try {
            const response = await fetch(API_BASE + '/status', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({secret_key: userSecretKey})
            });
           
            const result = await response.json();
           
            if (response.ok && result.status !== 'no_active_session') {
                document.getElementById('botStatusDisplay').textContent = result.status;
                document.getElementById('assignedServer').textContent = result.assigned_server;
                document.getElementById('startedAt').textContent = result.started_at;
                document.getElementById('lastUpdated').textContent = new Date().toLocaleString();
               
                const stopBtn = document.getElementById('stopBtn');
                if (result.status === 'running') {
                    stopBtn.disabled = false;
                    document.getElementById('botStatusDisplay').innerHTML = '<span style="color: var(--success);">üü¢ RUNNING (24/7)</span>';
                    document.getElementById('qrSection').style.display = 'block';
                } else {
                    stopBtn.disabled = true;
                    document.getElementById('botStatusDisplay').innerHTML = '<span style="color: var(--danger);">üî¥ STOPPED</span>';
                    document.getElementById('qrSection').style.display = 'none';
                }
            } else {
                document.getElementById('botStatusDisplay').innerHTML = '<span style="color: #6b7280;">‚ö™ NO ACTIVE SESSION</span>';
                document.getElementById('assignedServer').textContent = '-';
                document.getElementById('startedAt').textContent = '-';
                document.getElementById('stopBtn').disabled = true;
                document.getElementById('qrSection').style.display = 'none';
            }
        } catch (error) {
            handleFetchError(error, 'update status');
        }
    }

    function startStatusMonitoring() {
        if (botStatusInterval) clearInterval(botStatusInterval);
        botStatusInterval = setInterval(updateBotStatus, 10000);
       
        if (activityUpdateInterval) clearInterval(activityUpdateInterval);
        activityUpdateInterval = setInterval(loadUserActivity, 30000);
       
        setInterval(checkServerStatus, 60000);
    }

    async function checkServerStatus() {
        try {
            const response = await fetch(API_BASE + '/server_status');
            const result = await response.json();
           
            const serverStatusDiv = document.getElementById('serverStatus');
            serverStatusDiv.innerHTML = '';
           
            let onlineServers = 0;
           
            for (const [server, status] of Object.entries(result.servers)) {
                const serverDiv = document.createElement('div');
                serverDiv.className = 'server-status';
               
                const statusDot = document.createElement('span');
                statusDot.className = status ? 'status-dot status-online' : 'status-dot status-offline';
                serverDiv.appendChild(statusDot);
               
                const serverName = server.split('//')[1].split('.')[0];
                serverDiv.innerHTML += `${serverName} - <span style="color: ${status ? 'var(--success)' : 'var(--danger)'};">${status ? 'ONLINE' : 'OFFLINE'}</span>`;
               
                serverStatusDiv.appendChild(serverDiv);
                if (status) onlineServers++;
            }
           
            document.getElementById('serverCount').textContent = onlineServers;
           
        } catch (error) {
            handleFetchError(error, 'server status');
            document.getElementById('serverCount').textContent = '0';
        }
    }

    async function updateStats() {
        try {
            const response = await fetch(API_BASE + '/stats');
            if (response.ok) {
                const result = await response.json();
                document.getElementById('totalUsers').textContent = result.total_users || '0';
                document.getElementById('activeBots').textContent = result.active_bots || '0';
                document.getElementById('serverCount').textContent = result.server_count || '5';
            }
        } catch (error) {
            handleFetchError(error, 'stats');
            document.getElementById('totalUsers').textContent = '0';
            document.getElementById('activeBots').textContent = '0';
        }
    }

    // UI Management functions
    function showDashboard() {
        document.getElementById('authSection').style.display = 'none';
        document.getElementById('dashboardSection').style.display = 'block';
    }

    function showLogin() {
        document.getElementById('registerForm').style.display = 'none';
        document.getElementById('loginForm').style.display = 'block';
    }

    function showRegister() {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    }

    function showVerificationModal() {
        document.getElementById('verificationModal').style.display = 'flex';
    }

    function hideVerificationModal() {
        document.getElementById('verificationModal').style.display = 'none';
    }

    function showBotStatusModal() {
        document.getElementById('botStatusModal').style.display = 'flex';
    }

    function hideBotStatusModal() {
        document.getElementById('botStatusModal').style.display = 'none';
    }

    function showStatus(message, type) {
        const statusDiv = document.getElementById('status');
        statusDiv.textContent = message;
        statusDiv.className = `status status-${type}`;
        statusDiv.style.display = 'block';
       
        if (type === 'success') {
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }
    }

    function copySecretKey() {
        if (!userSecretKey) {
            showStatus('No secret key available', 'error');
            return;
        }
       
        navigator.clipboard.writeText(userSecretKey).then(() => {
            showStatus('Secret key copied to clipboard!', 'success');
        }).catch(() => {
            showStatus('Failed to copy secret key', 'error');
        });
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
       
        const targetTab = document.getElementById(tabName + 'Tab');
        if (targetTab) {
            targetTab.classList.add('active');
        }
       
        if (event && event.target) {
            event.target.classList.add('active');
        }
    }

    // Utility functions
    function setupFormHandlers() {
        console.log('Setting up form handlers...');
        
        document.addEventListener('submit', function(e) {
            if (e.target.id === 'loginForm') {
                e.preventDefault();
                loginWithValidation();
            }
            if (e.target.id === 'registerForm') {
                e.preventDefault();
                registerWithValidation();
            }
        });

        const loginBtn = document.querySelector('#loginForm button[type="submit"]');
        const registerBtn = document.querySelector('#registerForm button[type="submit"]');
        
        if (loginBtn) {
            loginBtn.addEventListener('click', function(e) {
                e.preventDefault();
                loginWithValidation();
            });
        }
        
        if (registerBtn) {
            registerBtn.addEventListener('click', function(e) {
                e.preventDefault();
                registerWithValidation();
            });
        }

        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (e.target.closest('#loginForm')) {
                    e.preventDefault();
                    loginWithValidation();
                }
                if (e.target.closest('#registerForm')) {
                    e.preventDefault();
                    registerWithValidation();
                }
                if (e.target.closest('#verificationModal')) {
                    e.preventDefault();
                    verifyEmail();
                }
            }
        });

        const verifyBtn = document.querySelector('#verificationModal button');
        if (verifyBtn) {
            verifyBtn.addEventListener('click', verifyEmail);
        }

        const spreadsheetInput = document.getElementById('spreadsheetUrl');
        if (spreadsheetInput) {
            spreadsheetInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    saveSpreadsheet();
                }
            });
        }
    }

    function enableAllButtons() {
        document.querySelectorAll('button').forEach(btn => {
            btn.disabled = false;
            btn.style.pointerEvents = 'auto';
            btn.style.opacity = '1';
        });
    }

    function isValidEmail(email) {
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        return emailRegex.test(email);
    }

    function formatDate(dateString) {
        if (!dateString) return '-';
        const date = new Date(dateString);
        return date.toLocaleString();
    }

    function saveUserSession() {
        if (userSecretKey && userEmail) {
            localStorage.setItem('userSecretKey', userSecretKey);
            localStorage.setItem('userEmail', userEmail);
        }
    }

    function clearUserSession() {
        localStorage.removeItem('userSecretKey');
        localStorage.removeItem('userEmail');
        userSecretKey = '';
        userEmail = '';
    }

    function logout() {
        clearUserSession();
        document.getElementById('dashboardSection').style.display = 'none';
        document.getElementById('authSection').style.display = 'block';
        showLogin();
        showStatus('Logged out successfully', 'success');
       
        if (botStatusInterval) clearInterval(botStatusInterval);
        if (activityUpdateInterval) clearInterval(activityUpdateInterval);
    }

    function handleFetchError(error, operation) {
        console.error(`Error during ${operation}:`, error);
        let msg = `Error during ${operation}: `;
        
        if (error.message.includes('Failed to fetch')) {
            msg += 'Cannot connect to server. Please check your internet connection and ensure the backend is running.';
        } else if (error.message.includes('401')) {
            msg += 'Invalid email or password. Please check your credentials.';
        } else if (error.message.includes('Unexpected token')) {
            msg += 'Server response error. Please try again later.';
        } else {
            msg += error.message;
        }
        
        showStatus(msg, 'error');
        if (operation.includes('bot')) {
            addBotLog(`‚ùå ${operation} failed: ${error.message}`, 'error');
        }
    }

    function checkExistingSession() {
        const savedSecretKey = localStorage.getItem('userSecretKey');
        const savedEmail = localStorage.getItem('userEmail');
       
        if (savedSecretKey && savedEmail) {
            userSecretKey = savedSecretKey;
            userEmail = savedEmail;
            showDashboard();
            loadUserProfile();
            loadUserActivity();
            startStatusMonitoring();
        }
    }

    async function checkBackendHealth() {
        try {
            const response = await fetch(API_BASE + '/health');
            if (response.ok) {
                console.log('‚úÖ Backend is reachable');
                return true;
            }
        } catch (error) {
            console.error('‚ùå Backend is not reachable:', error);
            showStatus('Backend server is not available. Please try again later.', 'error');
            return false;
        }
    }

    // Initialize application
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ WhatsApp Bulk Messenger Pro Frontend Initialized');
        console.log('API Base URL:', API_BASE);
       
        enableAllButtons();
        setupFormHandlers();
        
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.textContent.toLowerCase().replace(' ', '');
                switchTab(tabName);
            });
        });
       
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const saveSheetBtn = document.getElementById('saveSheetBtn');
        const copyKeyBtn = document.getElementById('copyKeyBtn');
        const logoutBtn = document.getElementById('logoutBtn');
       
        if (startBtn) startBtn.addEventListener('click', startBot);
        if (stopBtn) stopBtn.addEventListener('click', stopBot);
        if (saveSheetBtn) saveSheetBtn.addEventListener('click', saveSpreadsheet);
        if (copyKeyBtn) copyKeyBtn.addEventListener('click', copySecretKey);
        if (logoutBtn) logoutBtn.addEventListener('click', logout);
       
        checkBackendHealth();
        updateStats();
        checkServerStatus();
       
        setInterval(updateStats, 30000);
        setInterval(checkServerStatus, 60000);
       
        checkExistingSession();
        
        console.log('Form handlers setup complete');
        console.log('Login button:', document.querySelector('#loginForm button'));
        console.log('Register button:', document.querySelector('#registerForm button'));
    });
</script>
</body>
</html>
